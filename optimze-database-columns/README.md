# Database Column Optimization Scripts

This directory contains Python scripts for optimizing database columns by analyzing current data types and suggesting more efficient alternatives.

## Overview

These scripts help you identify and implement database schema optimizations to improve performance and reduce storage requirements. The workflow consists of:

1. **analyze-columns.py**: Analyzes database tables and columns to identify optimization opportunities
2. **build-sql.py**: Generates SQL ALTER TABLE statements based on the analysis results

## Script: analyze-columns.py

This script connects to MySQL/MariaDB databases, analyzes column data types and content, and recommends more efficient data types.

<details>
<summary>Details</summary>

### Features

- Analyzes multiple databases in parallel
- Detects oversized column types based on actual data content
- Supports various data types (VARCHAR, INT, TEXT, etc.)
- Generates detailed CSV reports with optimization recommendations
- Creates a summary report with statistics

### Requirements

- Python 3.6+
- PyMySQL library (`pip install pymysql`)
- Access to MySQL/MariaDB databases (local socket or network)

### Configuration

Create a `config.json` file with the following parameters:

```json
{
  "host": "localhost",
  "user": "username",
  "password": "password",
  "central_db": "main_database",
  "tenant_db_pattern": "tenant_%",
  "max_workers": 5,
  "log_level": "INFO",
  "output_file": "schema_optimization_report.csv"
}
```

### Usage

Run the script with:

```sh
python analyze-columns.py
```

### Output

The script generates two files:
- `schema_optimization_report.csv` - Detailed analysis of each column
- `schema_optimization_report_summary.txt` - Summary statistics of findings

</details>

## Script: build-sql.py

This script processes the CSV report generated by `analyze-columns.py` and creates SQL statements to implement the recommended optimizations.

<details>
<summary>Details</summary>

### Features

- Parses CSV reports with column optimization recommendations
- Generates properly formatted ALTER TABLE statements
- Includes comments with current and recommended types
- Creates a single SQL file with all optimization statements

### Usage

1. First, generate the CSV report using `analyze-columns.py`
2. Run this script to generate SQL statements:

```sh
python build-sql.py
```

By default, the script:
- Reads from `schema_optimization_report.csv`
- Outputs to `schema_optimization_queries.sql`

### Output Example

The generated SQL will look like:

```sql
ALTER TABLE mydatabase.users MODIFY COLUMN name VARCHAR(50);
ALTER TABLE mydatabase.orders MODIFY COLUMN status CHAR(8);
```

### Important Notes

- Always review generated SQL statements before execution
- Test changes in a non-production environment first
- Consider application compatibility with data type changes
- Take database backups before applying schema changes

</details>

## Complete Workflow

1. Configure `config.json` with your database connection details
2. Run `analyze-columns.py` to generate the optimization report
3. Review the generated CSV for appropriate optimization suggestions
4. Run `build-sql.py` to generate SQL statements
5. Review the SQL statements for correctness
6. Execute the SQL in a test environment
7. After validation, apply changes to production

## Cautions

- Always back up your database before making schema changes
- Test thoroughly after making type changes
- Some applications may have hardcoded assumptions about column types
- Consider the performance impact during ALTER TABLE operations on large tables
